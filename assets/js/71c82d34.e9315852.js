"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9029],{910:(t,n,e)=>{e.r(n),e.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var l=e(4848),s=e(8453);const r={sidebar_label:"libcurl-multifiles-download",sidebar_position:4},i="\u7b80\u4ecb",o={id:"libcurl-multifiles-download",title:"\u7b80\u4ecb",description:"\u5c01\u88c5\u4e86libcurl\u7528\u4e8e\u652f\u6301\u540c\u65f6\u4e0b\u8f7d\u591a\u4e2a\u5927\u6587\u4ef6\u3001\u591a\u7ebf\u7a0b\u5e76\u53d1\u5206\u7247\u4e0b\u8f7d\u3002",source:"@site/docs/libcurl-multifiles-download.md",sourceDirName:".",slug:"/libcurl-multifiles-download",permalink:"/docs/libcurl-multifiles-download",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/libcurl-multifiles-download.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_label:"libcurl-multifiles-download",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"config-center-demo",permalink:"/docs/config-center-demo"},next:{title:"C++",permalink:"/docs/category/c"}},a={},c=[{value:"CurlTaskInfo",id:"curltaskinfo",level:2},{value:"\u6dfb\u52a0\u4e0b\u8f7d\u6587\u4ef6\u5230\u961f\u5217",id:"\u6dfb\u52a0\u4e0b\u8f7d\u6587\u4ef6\u5230\u961f\u5217",level:2},{value:"\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u4e00\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\uff0c\u5e76\u6267\u884c\u4e0b\u8f7d",id:"\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u4e00\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\u5e76\u6267\u884c\u4e0b\u8f7d",level:2},{value:"\u505c\u6b62\u4e0b\u8f7d",id:"\u505c\u6b62\u4e0b\u8f7d",level:2},{value:"\u5206\u7247\u5904\u7406",id:"\u5206\u7247\u5904\u7406",level:2},{value:"\u5bf9\u6bcf\u4e2a\u5206\u7247job\u8fdb\u884c\u5904\u7406",id:"\u5bf9\u6bcf\u4e2a\u5206\u7247job\u8fdb\u884c\u5904\u7406",level:2},{value:"\u4e0b\u8f7d\u5355\u4e2a\u5206\u7247",id:"\u4e0b\u8f7d\u5355\u4e2a\u5206\u7247",level:2},{value:"\u8fdb\u5ea6",id:"\u8fdb\u5ea6",level:2},{value:"\u5199\u6570\u636e",id:"\u5199\u6570\u636e",level:2},{value:"\u6587\u4ef6\u5927\u5c0f",id:"\u6587\u4ef6\u5927\u5c0f",level:2},{value:"\u5185\u5bb9\u957f\u5ea6",id:"\u5185\u5bb9\u957f\u5ea6",level:2}];function u(t){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...t.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u7b80\u4ecb",children:"\u7b80\u4ecb"})}),"\n",(0,l.jsx)(n.p,{children:"\u5c01\u88c5\u4e86libcurl\u7528\u4e8e\u652f\u6301\u540c\u65f6\u4e0b\u8f7d\u591a\u4e2a\u5927\u6587\u4ef6\u3001\u591a\u7ebf\u7a0b\u5e76\u53d1\u5206\u7247\u4e0b\u8f7d\u3002"}),"\n",(0,l.jsx)(n.h1,{id:"\u95ee\u9898",children:"\u95ee\u9898"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"\u6253\u5f00\u6587\u4ef6\u6a21\u5f0f ab;"}),"\n",(0,l.jsx)(n.li,{children:"curl\u4e0b\u8f7d\u5355\u4e2a\u8d854G\u5927\u5c0f\u6587\u4ef6\u9700\u4f7f\u7528CURLOPT_RESUME_FROM_LARGE \u9009\u9879;"}),"\n"]}),"\n",(0,l.jsx)(n.h1,{id:"\u804c\u8d23",children:"\u804c\u8d23"}),"\n",(0,l.jsx)(n.p,{children:"CDownloadTaskManager\uff1a \u63d0\u4f9b\u6dfb\u52a0\u6587\u4ef6\u4e0b\u8f7d\u63a5\u53e3\uff0c\u8c03\u5ea6\u5e76\u5206\u914d\u591a\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\u3002\nCFileTaskInfo: \u5bf9\u7247\u5904\u7406\uff0c\u4ece\u7ebf\u7a0b\u6c60\u4e2d\u53d6\u51fa\u4e00\u4e2a\u7ebf\u7a0b\uff0c\u6267\u884c\u5355\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\uff0c\u5e76\u56de\u8c03\u4e0b\u8f7d\u8fdb\u5ea6\u3002\nCCurlDownloader: \u5c01\u88c5libcurl\uff0c\u63d0\u4f9b\u4e0b\u8f7d\u529f\u80fd\u3002\nthreadpool\uff1a \u7ebf\u7a0b\u6c60\u3002"}),"\n",(0,l.jsx)(n.h1,{id:"\u6570\u636e\u7ed3\u6784",children:"\u6570\u636e\u7ed3\u6784"}),"\n",(0,l.jsx)(n.h2,{id:"curltaskinfo",children:"CurlTaskInfo"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"//\u4e0b\u8f7d\u4efb\u52a1\u4fe1\u606f\n//\u8fd9\u91cc\u5fc5\u987b\u662fstruct\u800c\u4e0d\u80fd\u662fclass\nstruct CurlTaskInfo\n{\n\tCurlTaskInfo() : fp(nullptr), originPos(0), startPos(0), stopPos(0), lastPos(0), ranged(false), remoteFileLength(0), nIndex(0), pDownloaderCallback(nullptr)\n\t{\n\t\tpDownloader = nullptr;\n\t\tcurl = nullptr;\n\t}\n\n\tCurlTaskInfo(\n\t\tFILE* _fp, \n\t\tconst std::string _url, \n\t\t//CURL *_pCurl, \n\t\tbool _ranged, \n\t\tsize_t _remoteFileLength, \n\t\tsize_t _startPos, \n\t\tsize_t _stopPos, \n\t\tunsigned int _nIndex, \n\t\tCFileTaskInfo* _pFileTaskInfo,\n\t\tCDownloaderCallback* pDownloadCallback): curl(nullptr), pFileTaskInfo(nullptr), pDownloader(nullptr),\n\t\tpDownloaderCallback(pDownloadCallback)\n\t{\n\t\tfp = _fp;\n\t\turl = _url;\n\t\t//curl = _pCurl;\n\t\tranged = _ranged;\n\t\tremoteFileLength = _remoteFileLength;\n\t\tstartPos = _startPos;\n\t\tstopPos = _stopPos;\n\t\toriginPos = _startPos;\n\t\tlastPos = _startPos;\n\t\tnIndex = _nIndex;\n\t\t//pDownloader = _pDownloader;\n\t\tpFileTaskInfo = _pFileTaskInfo;\n\t}\n\n\tFILE*    fp;\t\t\t\t//\u672c\u5730\u6587\u4ef6\u53e5\u67c4\n\tstd::string  url;\t\t\t//url \n\tCURL*\tcurl;\t\t\t\t//curl \u5bf9\u8c61\n\tbool    ranged;\t\t\t\t//\u662f\u5426\u9700\u8981 http range\u4e0b\u8f7d?\n\tsize_t\tremoteFileLength;\t//\u6587\u4ef6\u603b\u957f\u5ea6\n\n\tsize_t\t originPos;\t\t\t//\u5206\u6bb5\u8d77\u59cb\u70b9\n\tsize_t   lastPos;\t\t\t//\u8fdb\u5ea6\u4e0a\u4e00\u4e2a\u4f4d\u7f6e\n\tsize_t   startPos;\t\t\t//\u8fdb\u5ea6\u5f53\u524d\u4f4d\u7f6e\n\tsize_t   stopPos;\t\t\t//\u5206\u6bb5\u7ec8\u70b9\n\tunsigned int nIndex;\t\t//\u5206\u6bb5\u7d22\u5f15\n\n\tCFileTaskInfo * pFileTaskInfo;\n\tCCurlDownloader* pDownloader;\n\tCDownloaderCallback* pDownloaderCallback;\n};\n"})}),"\n",(0,l.jsx)(n.h1,{id:"cdownloadtaskmanager",children:"CDownloadTaskManager"}),"\n",(0,l.jsx)(n.h2,{id:"\u6dfb\u52a0\u4e0b\u8f7d\u6587\u4ef6\u5230\u961f\u5217",children:"\u6dfb\u52a0\u4e0b\u8f7d\u6587\u4ef6\u5230\u961f\u5217"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"void CDownloadTaskManager::DownloadFile(const char* url, const char* name, CDownloaderCallback* pCallback)\n{\n\tCFileTaskInfo* pInfo = new CFileTaskInfo(url, name, pCallback, true, m_nLimitThread);\n\tm_lstFileTaskInfo.push_back(pInfo);\n\n\tif (m_hThread == nullptr)\n\t{\n\t\tm_hThread = (HANDLE)_beginthreadex(NULL, 0, (_beginthreadex_proc_type)DownloadFileCallback, (void*)this, 0, 0);\n\t}\n\telse\n\t{\n\t\tNotifyEvent();\n\t}\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u4e00\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\u5e76\u6267\u884c\u4e0b\u8f7d",children:"\u4ece\u961f\u5217\u4e2d\u53d6\u51fa\u4e00\u4e2a\u6587\u4ef6\u4e0b\u8f7d\u4efb\u52a1\uff0c\u5e76\u6267\u884c\u4e0b\u8f7d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"void CDownloadTaskManager::DoingTask()\n{\n\twhile (true)\n\t{\n\t\tif (m_lstFileTaskInfo.empty())\n\t\t{\n\t\t\tWaitForSingleObject(m_hEvent, INFINITE);\n\t\t\tcontinue;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlist<CFileTaskInfo*>::iterator iter = m_lstFileTaskInfo.begin();\n\t\t\tsize_t nDoingCount = 0;\n\t\t\twhile (iter != m_lstFileTaskInfo.end())\n\t\t\t{\n\t\t\t\tif ((*iter)->isDoing())\n\t\t\t\t{\n\t\t\t\t\t++nDoingCount;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// \u79fb\u9664\u5df2\u5b8c\u6210\u7684\u4e0b\u8f7d\u6587\u4ef6\u4efb\u52a1\n\t\t\t\t\tif (!(*iter)->getTotalTaskCount())\n\t\t\t\t\t{\n\t\t\t\t\t\titer = m_lstFileTaskInfo.erase(iter);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\titer++;\n\t\t\t}\n\t\t\tint nMinLimit = m_lstFileTaskInfo.size() < m_nLimitFiles ? m_lstFileTaskInfo.size() : m_nLimitFiles;\n\t\t\tif (nDoingCount >= nMinLimit)\n\t\t\t{\n\t\t\t\tWaitForSingleObject(m_hEvent, INFINITE);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\titer = m_lstFileTaskInfo.begin();\n\t\t\twhile (iter != m_lstFileTaskInfo.end())\n\t\t\t{\n\t\t\t\tif ((*iter)->getTotalTaskCount() && !(*iter)->isDoing())\n\t\t\t\t{\n\t\t\t\t\t(*iter)->DoingTask();\n\t\t\t\t}\n\t\t\t\titer++;\n\t\t\t}\n\t\t}\n\t}\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u505c\u6b62\u4e0b\u8f7d",children:"\u505c\u6b62\u4e0b\u8f7d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"void CDownloadTaskManager::Stop(const char* url)\n{\n\tstd::list<CFileTaskInfo*>::iterator iter = m_lstFileTaskInfo.begin();\n\n\twhile (iter != m_lstFileTaskInfo.end())\n\t{\n\t\tif (!(*iter)->isDifferentUrl(url))\n\t\t{\n\t\t\t(*iter)->Stop();\n\t\t}\n\t\titer++;\n\t}\n}\n"})}),"\n",(0,l.jsx)(n.h1,{id:"cfiletaskinfo",children:"CFileTaskInfo"}),"\n",(0,l.jsx)(n.h2,{id:"\u5206\u7247\u5904\u7406",children:"\u5206\u7247\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"bool CFileTaskInfo::GenerateTaskInfos(const std::string& urls, const std::string& localDirPath, bool bRanged)\n{\n\t// \u521d\u59cb\u5316\u53d8\u91cf\n\tbool bResult = false;\n\tFILE* fp;\n\tsize_t file_len = 0, start=0, stop=0, seg_num=0;\n\tbool ranged = bRanged;\n\tCurlTaskInfo* pTi= nullptr;\n\n\t// \u53d6\u8fdc\u7a0b\u6587\u4ef6\u5927\u5c0f\n\tfile_len = CCurlDownloader::getDownloadFileSize(urls.c_str());\n\tif (file_len <= 0) return bResult;\n\tm_llFileLength = file_len;\n\n\t// \u6587\u4ef6\u540d\n\tsize_t nIndex = localDirPath.find_last_of('\\\\');\n\tstring fileName = localDirPath.substr(nIndex + 1, localDirPath.length() - nIndex);\n\n\t//\u5bf9\u5e94\u6bcf\u4e2aurl, \u6253\u5f00\u4e00\u4e2a\u672c\u5730\u6587\u4ef6\n\tstring full_path = localDirPath.c_str();\n\tsize_t local_file_len = CFileHelper::GetFileLength(full_path);\n\tfp = fopen(full_path.c_str(), \"wb+\"); //\u6253\u5f00\u6587\u4ef6\n\tif (nullptr == fp) return bResult;\n\n\tm_CloseTaskInfo.fp = fp;\n\tm_CloseTaskInfo.url = urls;\n\t\n\n\t//\u52a0\u5165\u5168\u5c40\u4efb\u52a1\u76d1\u542c\u6620\u5c04\n\tsize_t additional = (file_len % m_segSize == 0) ? 0 : 1;\n\tsize_t seg_total = ranged ? (file_len < m_segSize ? 1 : (file_len / m_segSize + additional)) : 1;\n\tm_nTotalTask = (int)seg_total;\n\n\tif (ranged)\n\t{\n\t\t//\u6839\u636e\u6587\u4ef6\u5927\u5c0f, \u786e\u5b9a\u662f\u5426\u5206\u7247?\n\t\tif (file_len < m_segSize)\n\t\t{\n\t\t\tstart = 0;\n\t\t\tstop = file_len - 1;\n\t\t\tpTi = new CurlTaskInfo(fp, urls.c_str(), ranged, file_len, start, stop, 0, this, nullptr);\n\t\t\tm_vecCurlTaskInfo.push_back(pTi);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t//\u5206\u7247\u4e0b\u8f7d,\u5148\u786e\u5b9a\u5206\u7247\u4e2a\u6570\n\t\t\tseg_num = file_len / m_segSize;\n\t\t\tfor (size_t i = 0; i < (seg_num + additional); i++) {\n\t\t\t\tif (i < seg_num) {\n\t\t\t\t\tstart = i * m_segSize;\n\t\t\t\t\tstop = (i + 1) * m_segSize - 1;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (file_len % m_segSize != 0) {\n\t\t\t\t\t\tstart = i * m_segSize;\n\t\t\t\t\t\tstop = file_len - 1;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tpTi = new CurlTaskInfo(fp, urls.c_str(), ranged, file_len, start, stop, (int)i, this, nullptr);\n\t\t\t\tm_vecCurlTaskInfo.push_back(pTi);\n\t\t\t}\n\t\t}\n\t}\n\telse\n\t{\n\t\tstart = (local_file_len > 0) ? (local_file_len) : 0;\n\t\tstop = file_len - 1;\n\t\tpTi = new CurlTaskInfo(fp, urls.c_str(), ranged, file_len, start, stop, 0, this, nullptr);\n\t\t\n\t\tm_vecCurlTaskInfo.push_back(pTi);\n\t}\n\n\n\treturn bResult;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5bf9\u6bcf\u4e2a\u5206\u7247job\u8fdb\u884c\u5904\u7406",children:"\u5bf9\u6bcf\u4e2a\u5206\u7247job\u8fdb\u884c\u5904\u7406"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"void CFileTaskInfo::DoingTask()\n{\n\tm_pCallback->OnDownloadBegin();\n\tm_bDoing = true;\n\n\tstd::vector< std::future<CurlTaskInfo*>> results;\n\tfor (int i = 0; i < m_vecCurlTaskInfo.size(); i++)\n\t{\n\t\tCurlTaskInfo* cti = m_vecCurlTaskInfo[i];\n\t\tresults.emplace_back(\n\t\t\tm_ppools->commit([cti] {\n\t\t\tdo {\n\t\t\t\tCCurlDownloader *p = new CCurlDownloader(cti->pFileTaskInfo, cti->pDownloaderCallback);\n\t\t\t\tp->Start(cti);\n\t\t\t} while (cti->startPos < cti->stopPos);\n\t\t\t\n\t\t\treturn cti;\n\t\t})\n\t\t);\n\t}\n}\n"})}),"\n",(0,l.jsx)(n.h1,{id:"ccurldownloader",children:"CCurlDownloader"}),"\n",(0,l.jsx)(n.h2,{id:"\u4e0b\u8f7d\u5355\u4e2a\u5206\u7247",children:"\u4e0b\u8f7d\u5355\u4e2a\u5206\u7247"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:'bool CCurlDownloader::taskProcess(void *arg)\n{\n\tbool bResult = false;\n\tCURL* curl;\n\tCURLcode res;\n\tCurlTaskInfo* ti = (CurlTaskInfo*)arg;\n\tti->pDownloader = this;\n\n\tchar range[64] = { 0 };\n\tif (ti->ranged) {\n\t\tsnprintf(range, sizeof(range), "%llu-%llu", ti->startPos, ti->stopPos);\n\t}\n\n\tcurl = curl_easy_init();\n\tcurl_easy_setopt(curl, CURLOPT_URL, ti->url.c_str());\n\tcurl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, writeData);\n\tcurl_easy_setopt(curl, CURLOPT_WRITEDATA, (void*)ti);\n\tcurl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_MAXREDIRS, 3);//\u67e5\u627e\u6b21\u6570\uff0c\u9632\u6b62\u67e5\u627e\u592a\u6df1\n\tcurl_easy_setopt(curl, CURLOPT_AUTOREFERER, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_NOSIGNAL, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_LOW_SPEED_LIMIT, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_LOW_SPEED_TIME, 5L);\n\tcurl_easy_setopt(curl, CURLOPT_FORBID_REUSE, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_XFERINFOFUNCTION, curlProgressFunc);\n\tcurl_easy_setopt(curl, CURLOPT_XFERINFODATA, (void*)ti);\n\tcurl_easy_setopt(curl, CURLOPT_NOPROGRESS, false);//\u8bbe\u4e3afalse \u4e0b\u9762\u624d\u80fd\u8bbe\u7f6e\u8fdb\u5ea6\u54cd\u5e94\u51fd\u6570\n\t//curl_easy_setopt(curl, CURLOPT_RESUME_FROM_LARGE, ti->startPos);//\u65ad\u70b9\u4e0b\u8f7d\u8bbe\u7f6e\n\t//curl_easy_setopt(curl, CURLOPT_BUFFERSIZE, 1024*10);//\u65ad\u70b9\u4e0b\u8f7d\u8bbe\u7f6e\n\t//curl_easy_setopt(curl, CURLOPT_CONNECTTIMEOUT, 5);//\u8bbe\u7f6e\u8fde\u63a5\u8d85\u65f6\uff0c\u5355\u4f4d\u79d2\n\t///*\n\tcurl_easy_setopt(curl, CURLOPT_VERBOSE, 1L);\n\tcurl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L);\n\tcurl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L);\n\t//*/\n\t/*\n\tcurl_easy_setopt(curl, CURLOPT_PROGRESSFUNCTION, CurlProgressFunc);//\u8fdb\u5ea6\u54cd\u5e94\u51fd\u6570\n\tcurl_easy_setopt(curl, CURLOPT_PROGRESSDATA, (void*)ji);//\u6570\u636e\u4f20\u8f93\u7684\u5bf9\u8c61\n\t//*/\n\n\tif (ti->ranged)\n\t\tcurl_easy_setopt(curl, CURLOPT_RANGE, range);\n\tti->curl = curl;\n\tres = curl_easy_perform(curl);\n\tif (CURLE_OK != res) \n\t{ \n\t\t//TRACE(L"curl_easy_perform return %d\\n", res);\n\t}\n\tcurl_easy_cleanup(curl);\n\n\tif (CURLE_OK == res && (ti->startPos == (ti->stopPos + 1)))\n\t{\n\t\tm_pParent->decreaseTotalTask();\n\t}\n\telse\n\t{\n\t\tm_pParent->resetTask(ti);\n\t}\n\n\tbResult = (CURLE_OK == res) && (ti->startPos == (ti->stopPos + 1));\n\treturn bResult;\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u8fdb\u5ea6",children:"\u8fdb\u5ea6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"int CCurlDownloader::curlProgressFunc(void *ptr, size_t totalToDownload, size_t nowDownloaded, size_t totalToUpLoad, size_t nowUpLoaded)\n{\n\tCurlTaskInfo* ji = (CurlTaskInfo*)ptr;\n\tstd::mutex& mtx = ji->pDownloader->GetMutexProgress();\n\tstd::lock_guard<std::mutex> lock(mtx);\n\n\tif (ji->lastPos < ji->originPos)\n\t{\n\t\tji->lastPos = ji->originPos;\n\t}\n\tif (ji->startPos != ji->lastPos)\n\t{\n\t\tsize_t nPos = ji->startPos - ji->lastPos;\n\t\tji->lastPos = ji->startPos;\n\n\t\tProgressData data(nPos, totalToDownload, ji->startPos, ji->stopPos, 0);\n\t\tji->pDownloader->OnDownloadProgress(data);\n\t}\n\n\treturn 0;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5199\u6570\u636e",children:"\u5199\u6570\u636e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"size_t CCurlDownloader::writeData(void *ptr, size_t size, size_t nmemb, void *userdata)\n{\n\t//\u591a\u7ebf\u7a0b\u5199\u540c\u4e00\u4e2a\u6587\u4ef6, \u9700\u8981\u52a0\u9501\n\tCurlTaskInfo* ji = (CurlTaskInfo*)userdata;\n\tstd::mutex& mtx = ji->pDownloader->GetMutexWrite();\n\tstd::lock_guard<std::mutex> lock(mtx);\n\n\t// \u53d6\u6d88\u4e0b\u7838\n\tif (ji->pFileTaskInfo != nullptr && ji->pFileTaskInfo->CancelDownload())\n\t{\n\t\treturn 0;\n\t}\n\n\tbool ranged = ji->ranged;\n\tsize_t written = 0;\n\t//\u8981\u5206\u7247\u4e0b\u8f7d\u7684\u5927\u6587\u4ef6, \u9700\u8981\u8bbe\u7f6ehttp range\u57df\n\tif (ranged) {\n\t\tif (ji->startPos + size * nmemb <= ji->stopPos) {\n\t\t\t_fseeki64(ji->fp, ji->startPos, SEEK_SET);\n\t\t\twritten = fwrite(ptr, size, nmemb, ji->fp);\n\t\t\tfflush(ji->fp);\n\t\t\tji->startPos += written;\n\t\t}\n\t\telse {\n\t\t\t_fseeki64(ji->fp, ji->startPos, SEEK_SET);\n\t\t\twritten = fwrite(ptr, 1, ji->stopPos - ji->startPos + 1, ji->fp);\n\t\t\tfflush(ji->fp);\n\t\t\tji->startPos += written;\n\t\t}\n\t}\n\telse {\n\t\tif (ji->startPos + size * nmemb <= ji->stopPos)\n\t\t{\n\t\t\t_fseeki64(ji->fp, ji->startPos, SEEK_SET);\n\t\t\twritten = fwrite(ptr, size, nmemb, ji->fp);\n\t\t\tfflush(ji->fp);\n\t\t\tji->startPos += written;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t_fseeki64(ji->fp, ji->startPos, SEEK_SET);\n\t\t\twritten = fwrite(ptr, 1, ji->stopPos - ji->startPos + 1, ji->fp);\n\t\t\tfflush(ji->fp);\n\t\t\tji->startPos += written;\n\t\t}\n\t}\n\treturn written;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u6587\u4ef6\u5927\u5c0f",children:"\u6587\u4ef6\u5927\u5c0f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:"size_t CCurlDownloader::getDownloadFileSize(const char* url)\n{\n\tdouble lensize = 0.0;\n\tfor (int iTry = 0; iTry < 2; iTry++)//\u7531\u4e8ecurl_easy_perform\u53ef\u80fd\u4f1a\u6709\u5076\u53d1\u6027\u7684CURLE_WRITE_ERROR\u9519\u8bef\uff0c\u6240\u4ee5\u6dfb\u52a0\u91cd\u8bd5\u673a\u5236\n\t{\n\t\tCURL *handle = curl_easy_init();\n\t\tcurl_easy_setopt(handle, CURLOPT_URL, url);\n\t\tcurl_easy_setopt(handle, CURLOPT_HEADER, 1);\n\t\tcurl_easy_setopt(handle, CURLOPT_FOLLOWLOCATION, 1);\n\t\tcurl_easy_setopt(handle, CURLOPT_NOBODY, 1);\n\t\tcurl_easy_setopt(handle, CURLOPT_SSL_VERIFYHOST, 0L);\n\t\tcurl_easy_setopt(handle, CURLOPT_SSL_VERIFYPEER, 0L);\n\t\tCURLcode res = curl_easy_perform(handle), resGetInfo = CURLE_OK;\n\t\tif (res == CURLE_OK) {\n\t\t\tresGetInfo = curl_easy_getinfo(handle, CURLINFO_CONTENT_LENGTH_DOWNLOAD, &lensize);\n\t\t\tif (CURLE_OK == resGetInfo)\n\t\t\t{\n\t\t\t\tcurl_easy_cleanup(handle);\n\t\t\t\treturn (size_t)lensize;\n\t\t\t}\n\t\t}\n\t\tcurl_easy_cleanup(handle);\n\t\tSleep(200); //\u4e3a\u4ec0\u4e48\u9700\u8981\u5ef6\u8fdf\n\t}\n\treturn 0;\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u5185\u5bb9\u957f\u5ea6",children:"\u5185\u5bb9\u957f\u5ea6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-cpp",children:'size_t CCurlDownloader::getContentLengthFunc(void * ptr, size_t size, size_t nmemb, void * stream)\n{\n\tLONGLONG len = 0;\n\tint r = sscanf((const char *)ptr, "Content-Length:%I64d\\n", &len);\n\tif (r)\n\t{\n\t\t*((LONGLONG *)stream) = len;\n\t}\n\treturn size * nmemb;\n}\n'})}),"\n",(0,l.jsx)(n.h1,{id:"threadpool",children:"threadpool"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://github.com/wenbozou/threadpool",children:"\u7ebf\u7a0b\u6c60C++11\u5b9e\u73b0"})})]})}function d(t={}){const{wrapper:n}={...(0,s.R)(),...t.components};return n?(0,l.jsx)(n,{...t,children:(0,l.jsx)(u,{...t})}):u(t)}},8453:(t,n,e)=>{e.d(n,{R:()=>i,x:()=>o});var l=e(6540);const s={},r=l.createContext(s);function i(t){const n=l.useContext(r);return l.useMemo((function(){return"function"==typeof t?t(n):{...n,...t}}),[n,t])}function o(t){let n;return n=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:i(t.components),l.createElement(r.Provider,{value:n},t.children)}}}]);