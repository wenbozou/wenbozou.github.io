"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6002],{9526:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var r=t(4848),s=t(8453);const a={sidebar_label:"PcGuardService",sidebar_position:3},o="PcGuardService",l={id:"Tenorshare/PcGuardService",title:"PcGuardService",description:"\u7b80\u4ecb",source:"@site/docs/Tenorshare/PcGuardService.md",sourceDirName:"Tenorshare",slug:"/Tenorshare/PcGuardService",permalink:"/docs/Tenorshare/PcGuardService",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Tenorshare/PcGuardService.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_label:"PcGuardService",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"libcurl-multifiles-download",permalink:"/docs/Tenorshare/libcurl-multifiles-download"},next:{title:"ProductDumpFileAnalysis",permalink:"/docs/Tenorshare/ProductDumpFileAnalysis"}},i={},c=[{value:"\u7b80\u4ecb",id:"\u7b80\u4ecb",level:2},{value:"\u521b\u5efa\u670d\u52a1",id:"\u521b\u5efa\u670d\u52a1",level:2},{value:"\u81ea\u6258\u7ba1\u670d\u52a1\u5668",id:"\u81ea\u6258\u7ba1\u670d\u52a1\u5668",level:2},{value:"1.\u5b9a\u4e49TaskController\u7c7b\uff0c\u4ece\u57fa\u7c7bApiController\u6d3e\u751f,\u5e76\u5b9e\u73b0\u4e24\u4e2a\u63a5\u53e3\uff1acreate\u548cstate\u3002",id:"1\u5b9a\u4e49taskcontroller\u7c7b\u4ece\u57fa\u7c7bapicontroller\u6d3e\u751f\u5e76\u5b9e\u73b0\u4e24\u4e2a\u63a5\u53e3create\u548cstate",level:3},{value:"2.\u521d\u59cb\u5316webapi\u670d\u52a1",id:"2\u521d\u59cb\u5316webapi\u670d\u52a1",level:3},{value:"3.\u542f\u52a8\u670d\u52a1",id:"3\u542f\u52a8\u670d\u52a1",level:3},{value:"\u5411\u540e\u7aef\u670d\u52a1\u6ce8\u518c\u672c\u673a\u4fe1\u606f",id:"\u5411\u540e\u7aef\u670d\u52a1\u6ce8\u518c\u672c\u673a\u4fe1\u606f",level:2},{value:"Ftp \u4e0b\u8f7d\u6587\u4ef6",id:"ftp-\u4e0b\u8f7d\u6587\u4ef6",level:2},{value:"\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8986\u76d6\u5df2\u5b58\u5728\u7684location.json\u914d\u7f6e\u6587\u4ef6",id:"\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8986\u76d6\u5df2\u5b58\u5728\u7684locationjson\u914d\u7f6e\u6587\u4ef6",level:2},{value:"\u9759\u9ed8\u5b89\u88c5\u7a0b\u5e8f\u5305",id:"\u9759\u9ed8\u5b89\u88c5\u7a0b\u5e8f\u5305",level:2},{value:"log4net \u65e5\u5fd7\u8bb0\u5f55",id:"log4net-\u65e5\u5fd7\u8bb0\u5f55",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"pcguardservice",children:"PcGuardService"})}),"\n",(0,r.jsx)(n.h2,{id:"\u7b80\u4ecb",children:"\u7b80\u4ecb"}),"\n",(0,r.jsx)(n.p,{children:"PcGuardService\u662f\u4e00\u6b3e\u57fa\u4e8eWindows\u7cfb\u7edf\u7684\u81ea\u52a8\u5316\u4efb\u52a1\u5b88\u62a4\u670d\u52a1\u8fdb\u7a0b\uff0c\u5b83\u5bf9\u63a5\u670d\u52a1\u540e\u7aef\u3001\u81ea\u52a8\u5316\u73af\u5883\u90e8\u7f72\u5de5\u5177\u3001\u81ea\u52a8\u5316\u5de5\u5177\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u521b\u5efa\u670d\u52a1",children:"\u521b\u5efa\u670d\u52a1"}),"\n",(0,r.jsxs)(n.p,{children:["C# Windows\u670d\u52a1",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/dotnet/framework/windows-services/how-to-create-windows-services",children:"\u6559\u7a0b"}),"\n\u793a\u4f8b\u4ee3\u7801",(0,r.jsx)(n.a,{href:"https://github.com/microsoft/Windows-classic-samples/tree/master/Samples/Win7Samples/winsvc/PcgGuardService",children:"Demo"})]}),"\n",(0,r.jsx)(n.h2,{id:"\u81ea\u6258\u7ba1\u670d\u52a1\u5668",children:"\u81ea\u6258\u7ba1\u670d\u52a1\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u4ece nuget \u83b7\u53d6 Microsoft.AspNet.WebApi.SelfHost \u5305\uff0c\u5e76\u4f7f\u7528\u5b83\u6765\u7f16\u5199 Web API \u670d\u52a1\u3002\n\u8fd4\u56de\u503c\u4e2d\u7684Json\u6570\u636e\u5e8f\u5217\u5316\uff0c\u8bf7\u4f7f\u7528ApiController\u7684Json\u65b9\u6cd5\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"1\u5b9a\u4e49taskcontroller\u7c7b\u4ece\u57fa\u7c7bapicontroller\u6d3e\u751f\u5e76\u5b9e\u73b0\u4e24\u4e2a\u63a5\u53e3create\u548cstate",children:"1.\u5b9a\u4e49TaskController\u7c7b\uff0c\u4ece\u57fa\u7c7bApiController\u6d3e\u751f,\u5e76\u5b9e\u73b0\u4e24\u4e2a\u63a5\u53e3\uff1acreate\u548cstate\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",metastring:'title="subclass TaskController"',children:"    public class public class TaskController : ApiController\n    {\n\n        /// <summary>\n        /// Post api/task/create\n        /// </summary>\n        [HttpPost]\n        public IHttpActionResult create([FromBody]ReceiveData receiveData)\n        {\n            ReturnData rd = new ReturnData();\n            //...\n            return Json(rd);\n        }\n\n        /// <summary>\n        /// Get api/task/state\n        /// </summary>\n        [HttpGet]\n        public IHttpActionResult state([FromUri]int subTaskId)\n        {\n            ReturnData rd = new ReturnData();\n            ///...\n            return Json(rd);\n        }\n    }\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2\u521d\u59cb\u5316webapi\u670d\u52a1",children:"2.\u521d\u59cb\u5316webapi\u670d\u52a1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",metastring:'title=""',children:'    public static class SelfHostedWebApiConfig\n    {\n        private static AutoResetEvent _autoResetEvent = new AutoResetEvent(false);\n        public static void Init()\n        {\n            try {\n                string url = "";\n                string ipAddress = $"http://{url}:18080";\n                // \u8bbe\u7f6e\u81ea\u6258\u7ba1\u670d\u52a1\u5668\u7684\u5730\u5740\n                var config = new HttpSelfHostConfiguration(ipAddress); ///"http://localhost:18080"\n\n                // \u914d\u7f6e\u9ed8\u8ba4\u8def\u7531\n                config.Routes.MapHttpRoute(\n                        name: "DefaultApi",\n                        routeTemplate: "api/{controller}/{action}/{id}",\n                        defaults: new { id = RouteParameter.Optional}\n                    );\n\n                // \u521b\u5efa\u5e76\u542f\u52a8\u81ea\u6258\u7ba1\u670d\u52a1\u5668\n                using (HttpSelfHostServer server = new HttpSelfHostServer(config))\n                {\n                    server.OpenAsync().Wait();\n                    _autoResetEvent.WaitOne();\n                }\n            }\n            catch (Exception ex)\n            {\n            }\n        }\n    }\n'})}),"\n",(0,r.jsx)(n.h3,{id:"3\u542f\u52a8\u670d\u52a1",children:"3.\u542f\u52a8\u670d\u52a1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",children:"_ = Task.Factory.StartNew(()=> { SelfHostedWebApiConfig.Init(); });\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5411\u540e\u7aef\u670d\u52a1\u6ce8\u518c\u672c\u673a\u4fe1\u606f",children:"\u5411\u540e\u7aef\u670d\u52a1\u6ce8\u518c\u672c\u673a\u4fe1\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",children:'private static readonly string _registerUri = "http://192.168.50.48:8096/machine/device/register";\nstring postData = JsonConvert.SerializeObject(di, Formatting.None);\nDictionary<string, string> requestHeader = new Dictionary<string, string>();\nrequestHeader.Add("Content-Type", "application/json");\nvar result = LibcurlCLR.LibcurlHelper.Post(_registerUri, postData, requestHeader, 60000, 60000);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"ftp-\u4e0b\u8f7d\u6587\u4ef6",children:"Ftp \u4e0b\u8f7d\u6587\u4ef6"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",children:"public bool Download(string ftpUri, string localFilePath)\n{\n    bool bResult = false;\n    FtpWebRequest request = (FtpWebRequest)WebRequest.Create(ftpUri);\n    request.Method = WebRequestMethods.Ftp.DownloadFile;\n\n    // \u8bbe\u7f6e\u4ec5\u7528\u6237\u540d\u7684\u51ed\u636e\n    request.Credentials = new NetworkCredential(_userName, _password);\n\n    try\n    {\n        using (FtpWebResponse response = (FtpWebResponse)request.GetResponse())\n        using (System.IO.Stream responseStream = response.GetResponseStream())\n        using (System.IO.FileStream fileStream = new System.IO.FileStream(localFilePath, System.IO.FileMode.Create))\n        {\n            responseStream.CopyTo(fileStream);\n            bResult = response.StatusCode == FtpStatusCode.ClosingData ? true : false; \n        }\n    }\n    catch (Exception ex)\n    {\n    }\n\n    return bResult;\n}        \n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8986\u76d6\u5df2\u5b58\u5728\u7684locationjson\u914d\u7f6e\u6587\u4ef6",children:"\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u4e0d\u8986\u76d6\u5df2\u5b58\u5728\u7684location.json\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,r.jsx)(n.p,{children:"1.\u5f00\u59cb\u5347\u7ea7\u65f6\u62f7\u8d1d\u5df2\u5b58\u5728\u7684location.json\u5230\u4e34\u65f6\u76ee\u5f55;\n2.\u5b89\u88c5\u5b8c\u6210\u540e\u518d\u5c06\u4e34\u65f6\u76ee\u5f55\u4e0b\u7684location.json\u62f7\u8d1d\u5230\u5b89\u88c5\u76ee\u5f55;\n3.\u5220\u9664\u4e34\u65f6\u76ee\u5f55\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"procedure CurStepChanged(CurStep: TSetupStep);\n var \n FailIfExists: Boolean;\n\tbegin\n\t\tif CurStep = ssInstall then\n\t\tbegin\n\t\t\tFileCopy(ExpandConstant('{app}\\\\Config\\\\location.json'), ExpandConstant('{localappdata}\\\\location.json'), FailIfExists);\n\t\tend;\n\tend;\n\nprocedure CurInstallProgressChanged(CurProgress, MaxProgress: Integer);\nvar \n FailIfExists: Boolean;\nbegin\n\tif CurProgress = MaxProgress then\n\tbegin\n\tFileCopy(ExpandConstant('{localappdata}\\\\location.json'), ExpandConstant('{app}\\\\Config\\\\location.json'), FailIfExists);\n\tend;\nend;\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u9759\u9ed8\u5b89\u88c5\u7a0b\u5e8f\u5305",children:"\u9759\u9ed8\u5b89\u88c5\u7a0b\u5e8f\u5305"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",metastring:'\u7528 Cmd \u6267\u884c "/VERYSILENT /SP- /NORESTART /DIR="{installTargetDir}" /LANG=en /LOG="{logName}" /sptrack " \u5373\u53ef\u3002',children:'string installTargetDir = $"{programFilesX86Path}\\\\{folderName}\\\\";\nstring logName = $"{System.AppDomain.CurrentDomain.BaseDirectory}Logs\\\\setup.log";\nstring curlParam = $"/VERYSILENT /SP- /NORESTART /DIR=\\"{installTargetDir}\\" /LANG=en /LOG=\\"{logName}\\" /sptrack ";\n\nProcessStartInfo startInfo = new ProcessStartInfo\n{\n    FileName = $"cmd.exe", // \u6307\u5b9a\u8981\u542f\u52a8\u7684\u5916\u90e8\u7a0b\u5e8f\u540d\u79f0  \n    Arguments = $"/c \\"\\"{packagePath}\\" {curlParam}\\"", // \u542f\u52a8\u65f6\u4f20\u9012\u7ed9\u7a0b\u5e8f\u7684\u53c2\u6570\n    UseShellExecute = false,       // \u4e0d\u4f7f\u7528\u7cfb\u7edf shell \u6267\u884c\n    CreateNoWindow = true,         // \u4e0d\u663e\u793a cmd \u7a97\u53e3\n    WorkingDirectory = AppDomain.CurrentDomain.BaseDirectory,\n};\n\n// \u521b\u5efa\u5e76\u542f\u52a8\u8fdb\u7a0b  \nusing (Process curlProc = Process.Start(startInfo))\n{\n    if (curlProc != null)\n    {\n        curlProc.WaitForExit();\n    }\n    else {}\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"log4net-\u65e5\u5fd7\u8bb0\u5f55",children:"log4net \u65e5\u5fd7\u8bb0\u5f55"}),"\n",(0,r.jsx)(n.p,{children:"1.\u5f15\u7528 log4net \u7a0b\u5e8f\u96c6\n2.\u521b\u5efa\u65e5\u5fd7\u914d\u7f6e\u6587\u4ef6 log4net.config"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="utf-8" ?>\n<configuration>\n  <configSections>\n    <section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler, log4net" />\n  </configSections>\n  <log4net>\n    \x3c!-- \u5b9a\u4e49\u4e00\u4e2a\u6587\u4ef6\u65e5\u5fd7\u8bb0\u5f55\u5668 --\x3e\n    <appender name="RollingFileAppender" type="log4net.Appender.RollingFileAppender">\n      \x3c!-- \u65e5\u5fd7\u6587\u4ef6\u7684\u8def\u5f84 --\x3e\n      <file value="logs\\" />\n      <rollingStyle value="Date" />\n      \x3c!-- \u6587\u4ef6\u683c\u5f0f--\x3e\n      \x3c!-- \u6587\u4ef6\u65e5\u5fd7\u7684\u56de\u6eda\u673a\u5236 --\x3e\n      <appendToFile value="true" />\n      \x3c!-- \u65e5\u5fd7\u6587\u4ef6\u7684\u6700\u5927\u5927\u5c0f --\x3e\n      <maximumFileSize value="10MB" />\n      \x3c!-- \u4fdd\u7559\u7684\u65e5\u5fd7\u6587\u4ef6\u4e2a\u6570 --\x3e\n      <maxSizeRollBackups value="5" />\n      \x3c!--\u5426\u91c7\u7528\u9759\u6001\u6587\u4ef6\u540d\uff0c\u6587\u4ef6\u540d\u662f\u5426\u552f\u4e00--\x3e\n      <staticLogFileName value="false"/>\n      \x3c!-- \u65e5\u5fd7\u683c\u5f0f --\x3e\n      <layout type="log4net.Layout.PatternLayout">\n        <conversionPattern value="%date %-5level %logger - %message%newline" />\n      </layout>\n    </appender>\n\n    \x3c!-- \u5b9a\u4e49\u4e00\u4e2a\u63a7\u5236\u53f0\u65e5\u5fd7\u8bb0\u5f55\u5668 --\x3e\n    <appender name="ConsoleAppender" type="log4net.Appender.ConsoleAppender">\n      <layout type="log4net.Layout.PatternLayout">\n        <conversionPattern value="%date %-5level %logger - %message%newline" />\n      </layout>\n    </appender>\n\n    \x3c!-- \u5b9a\u4e49\u65e5\u5fd7\u7ea7\u522b\u53ca\u9002\u7528\u7684appender --\x3e\n    <root>\n      \x3c!-- \u65e5\u5fd7\u7ea7\u522b\uff1aDEBUG, INFO, WARN, ERROR, FATAL --\x3e\n      <level value="DEBUG" />\n      <level value="INFO" />\n      \x3c!-- \u5173\u8054\u63a7\u5236\u53f0\u548c\u6587\u4ef6\u7684\u65e5\u5fd7\u8f93\u51fa --\x3e\n      <appender-ref ref="ConsoleAppender" />\n      <appender-ref ref="RollingFileAppender" />\n    </root>\n  </log4net>\n</configuration>\n'})}),"\n",(0,r.jsx)(n.p,{children:"3.\u5728\u5e94\u7528\u7a0b\u5e8f\u5165\u53e3\u5904\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",children:"XmlConfigurator.Configure();\n"})}),"\n",(0,r.jsx)(n.p,{children:"4.\u5728\u9700\u8981\u8bb0\u5f55\u65e5\u5fd7\u7684\u4ee3\u7801\u4e2d\uff0c\u901a\u8fc7 log4net \u8bb0\u5f55\u65e5\u5fd7"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cs",children:'ILog log = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);\nlog.Info("This is a log message.");\n\n\n'})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(6540);const s={},a=r.createContext(s);function o(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);